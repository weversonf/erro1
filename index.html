<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyRoutine v01</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(8px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .sidebar-transition { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        input { outline: none; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        /* Loader discreto de topo */
        .sync-loader { display: none; }
        body.is-loading .sync-loader { display: block; }
        
        :root { --primary: #2563eb; }
        .theme-bg { background-color: var(--primary) !important; }
        .theme-text { color: var(--primary) !important; }
        .theme-border { border-color: var(--primary) !important; }
        .theme-ring { --tw-ring-color: var(--primary) !important; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-300">

    <!-- BARRA DE SINCRONIZAÇÃO (FEEDBACK DISCRETO) -->
    <div class="sync-loader fixed top-0 left-0 right-0 h-1 z-[100] bg-blue-600 animate-pulse"></div>

    <div id="main-app" class="min-h-screen flex flex-col md:flex-row">
        <!-- SIDEBAR -->
        <nav id="sidebar" class="hidden md:flex flex-col border-r w-56 bg-white border-slate-200 dark:bg-slate-900 dark:border-slate-800 h-screen sticky top-0 transition-all duration-300">
            <div class="p-5 flex items-center justify-between">
                <span class="sidebar-label font-black text-[10px] theme-text uppercase tracking-widest">MyRoutine</span>
                <button onclick="toggleSidebar()" class="p-1.5 rounded-lg text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800"><i id="sidebar-icon" data-lucide="chevron-left" class="w-4 h-4"></i></button>
            </div>
            <div class="flex-1 px-3 space-y-1 pt-4">
                <button onclick="setView('today')" class="nav-item w-full flex items-center gap-3 p-3 rounded-xl text-xs font-bold text-slate-400 transition-all" data-nav="today"><i data-lucide="layout-dashboard" class="w-4 h-4"></i> <span class="sidebar-label">Hoje</span></button>
                <button onclick="setView('stats')" class="nav-item w-full flex items-center gap-3 p-3 rounded-xl text-xs font-bold text-slate-400 transition-all" data-nav="stats"><i data-lucide="trending-up" class="w-4 h-4"></i> <span class="sidebar-label">Evolução</span></button>
                <button onclick="setView('settings')" class="nav-item w-full flex items-center gap-3 p-3 rounded-xl text-xs font-bold text-slate-400 transition-all" data-nav="settings"><i data-lucide="settings" class="w-4 h-4"></i> <span class="sidebar-label">Ajustes</span></button>
            </div>
            <div class="p-5 border-t dark:border-slate-800">
                <div id="connection-status" class="flex items-center gap-2 text-[8px] font-black uppercase opacity-30 mb-4">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> Sincronizado
                </div>
                <button onclick="resetApp()" class="flex items-center gap-3 text-slate-400 font-bold text-[9px] p-2 w-full hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-all"><i data-lucide="refresh-cw" class="w-4 h-4"></i> <span class="sidebar-label uppercase tracking-widest">Reiniciar</span></button>
            </div>
        </nav>

        <!-- NAV MOBILE -->
        <nav class="md:hidden fixed bottom-0 left-0 right-0 border-t flex justify-around p-3 z-50 bg-white border-slate-200 dark:bg-slate-900 dark:border-slate-800 shadow-xl">
            <button onclick="setView('today')" class="nav-item p-2 text-slate-400" data-nav="today"><i data-lucide="layout-dashboard" class="w-6 h-6"></i></button>
            <button onclick="setView('stats')" class="nav-item p-2 text-slate-400" data-nav="stats"><i data-lucide="trending-up" class="w-6 h-6"></i></button>
            <button onclick="setView('settings')" class="nav-item p-2 text-slate-400" data-nav="settings"><i data-lucide="settings" class="w-6 h-6"></i></button>
        </nav>

        <main class="flex-1 transition-all duration-300 pb-24 md:pb-0">
            <div class="max-w-xl mx-auto p-5 lg:p-10 space-y-8">
                
                <!-- VIEW: HOJE -->
                <div id="view-today" class="view-section animate-slide-up space-y-8">
                    <header class="flex justify-between items-end">
                        <div class="space-y-0.5">
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Fortaleza • Ceará</p>
                            <h1 class="text-2xl font-black dark:text-white">Fala, <span id="user-display-name" class="theme-text">Makro</span>!</h1>
                        </div>
                        <div class="bg-orange-500/10 text-orange-600 px-3 py-1.5 rounded-xl flex items-center gap-2 border border-orange-500/10 text-[10px] font-black">
                            <i data-lucide="flame" class="w-4 h-4"></i> <span id="streak-val">0</span> dias
                        </div>
                    </header>

                    <!-- CARD ÁGUA -->
                    <section id="water-card" class="theme-bg p-6 rounded-[2.5rem] text-white shadow-2xl relative overflow-hidden transition-all duration-500 shadow-blue-500/20">
                        <div class="relative z-10 space-y-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-[9px] font-bold uppercase opacity-60 tracking-widest">Hidratação do Dia</p>
                                    <h2 class="text-4xl font-black tabular-nums tracking-tighter"><span id="total-drank">0</span><span class="text-sm font-normal opacity-50 ml-1.5">ml</span></h2>
                                    <p id="meta-label" class="text-[10px] font-bold opacity-80 mt-1">Meta: 3500ml</p>
                                </div>
                                <div class="p-3 bg-white/20 rounded-2xl backdrop-blur-md border border-white/20 shadow-lg"><i data-lucide="droplets" class="w-6 h-6"></i></div>
                            </div>
                            
                            <div class="w-full bg-black/10 h-3 rounded-full overflow-hidden shadow-inner">
                                <div id="progress-bar" class="bg-white h-full transition-all duration-1000 ease-out shadow-[0_0_15px_rgba(255,255,255,0.4)]" style="width: 0%"></div>
                            </div>

                            <div class="grid grid-cols-2 gap-3 pt-2">
                                <button onclick="addWater(473)" class="bg-white/10 p-4 rounded-2xl text-left hover:bg-white/20 active:scale-95 transition-all border border-white/5">
                                    <p class="text-[7px] font-black uppercase opacity-60">Copo Escritório</p>
                                    <p class="font-black text-sm">+473ml</p>
                                </button>
                                <button onclick="addWater(800)" class="bg-white/10 p-4 rounded-2xl text-left hover:bg-white/20 active:scale-95 transition-all border border-white/5">
                                    <p class="text-[7px] font-black uppercase opacity-60">Squeeze Fazer 250</p>
                                    <p class="font-black text-sm">+800ml</p>
                                </button>
                            </div>
                        </div>
                        <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
                    </section>

                    <section class="space-y-4">
                        <h3 class="text-xs font-black uppercase tracking-widest opacity-30">Rotina diária</h3>
                        <div id="tasks-list" class="grid gap-2.5"></div>
                    </section>
                </div>

                <!-- VIEW: EVOLUÇÃO -->
                <div id="view-stats" class="view-section hidden animate-slide-up space-y-6">
                    <h2 class="text-xl font-black">Performance</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-6 bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-[2rem] shadow-sm text-center">
                            <p id="stat-liters" class="text-3xl font-black theme-text">0L</p>
                            <p class="text-[10px] font-bold uppercase opacity-40">Água Total</p>
                        </div>
                        <div class="p-6 bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-[2rem] shadow-sm text-center">
                            <p id="stat-tasks" class="text-3xl font-black text-emerald-500">0</p>
                            <p class="text-[10px] font-bold uppercase opacity-40">Tarefas</p>
                        </div>
                    </div>
                </div>

                <!-- VIEW: AJUSTES -->
                <div id="view-settings" class="view-section hidden animate-slide-up space-y-8">
                    <h2 class="text-xl font-black">Ajustes</h2>
                    
                    <section class="p-8 bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-[2.5rem] shadow-sm space-y-8">
                        <div class="space-y-1">
                            <h3 class="text-sm font-black">Visual e Tema</h3>
                            <p class="text-[11px] text-slate-400">Personalize as cores da interface</p>
                        </div>

                        <div class="flex items-center justify-between">
                            <p class="text-xs font-bold">Modo Noturno</p>
                            <button onclick="toggleDark()" id="dark-btn-toggle" class="w-12 h-6.5 rounded-full relative bg-slate-200 dark:bg-slate-800 transition-all shadow-inner">
                                <div class="absolute top-1 left-1 w-4.5 h-4.5 bg-white rounded-full transition-all shadow-md"></div>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <p class="text-[9px] font-black uppercase opacity-40 tracking-widest">Cor de Destaque</p>
                            <div id="theme-colors" class="flex flex-wrap gap-4"></div>
                        </div>
                    </section>

                    <section class="p-8 bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-[2.5rem] shadow-sm space-y-6">
                        <h3 class="text-sm font-black">Fisiologia</h3>
                        
                        <div class="flex flex-col gap-6">
                            <div class="flex-1 space-y-2">
                                <label class="text-[10px] font-black uppercase opacity-40 ml-1">O Teu Peso (kg)</label>
                                <input id="set-weight" type="number" onchange="updateProfile('weight', this.value)" class="w-full p-4 rounded-2xl border dark:bg-slate-950 dark:border-slate-800 text-sm font-black focus:ring-2 theme-ring transition-all">
                            </div>

                            <div class="flex items-center justify-between p-6 bg-orange-500/5 border border-orange-500/10 rounded-2xl">
                                <div class="space-y-0.5">
                                    <p class="text-sm font-black text-orange-600">Modo Fortaleza</p>
                                    <p class="text-[10px] text-orange-600/60 font-medium">Ajuste climático (+20%)</p>
                                </div>
                                <button onclick="toggleFortaleza()" id="fortaleza-btn" class="w-12 h-6.5 rounded-full relative bg-slate-200 dark:bg-slate-800 transition-all shadow-inner">
                                    <div class="absolute top-1 left-1 w-4.5 h-4.5 bg-white rounded-full transition-all shadow-md"></div>
                                </button>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbxhV7ZfmDW_ESJlpbj--2AmkwpdrM2bZLb_dSYZb8JSDmBGyf_zfJv1Nsf5IvCC-d2j/exec";
        
        const themes = { blue: '#2563eb', green: '#059669', amber: '#d97706', rose: '#e11d48', purple: '#7c3aed', slate: '#475569' };

        // Estado inicial (Guest ou Último salvo)
        let state = JSON.parse(localStorage.getItem('mk_app_state')) || {
            user: localStorage.getItem('mk_login') || "Makro",
            pass: localStorage.getItem('mk_pass') || "guest",
            profile: { weight: 80, darkMode: true, theme: 'blue', fortaleza: true },
            tasks: [
                { id: '1', name: 'Água ao acordar (Copo 1)', time: '06:00', completed: false },
                { id: '2', name: 'Treino Academia', time: '07:00', completed: false },
                { id: '3', name: 'Início Trabalho Makro', time: '08:00', completed: false },
                { id: '4', name: 'Almoço Saudável', time: '12:00', completed: false },
                { id: '5', name: 'Revisão de Metas', time: '18:00', completed: false }
            ],
            water: [],
            view: 'today'
        };

        function saveLocal() {
            localStorage.setItem('mk_app_state', JSON.stringify(state));
        }

        // --- API SILENCIOSA COM TIMEOUT ---
        async function api(action, data = null) {
            document.body.classList.add('is-loading');
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); 

            try {
                let url = `${scriptURL}?action=${action}&login=${encodeURIComponent(state.user)}&senha=${encodeURIComponent(state.pass)}`;

                if (action === 'getData') {
                    const res = await fetch(url, { signal: controller.signal });
                    const result = await res.json();
                    if (result && result.success) {
                        state.profile = result.profile || state.profile;
                        state.tasks = result.tasks && result.tasks.length ? result.tasks : state.tasks;
                        state.water = result.water || state.water;
                        saveLocal();
                        render();
                    }
                    return result;
                } else {
                    // POSTs em background
                    fetch(scriptURL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({ action, login: state.user, data })
                    });
                    return { success: true };
                }

            } catch (e) {
                console.warn("Sync silenciado:", e.name === 'AbortError' ? 'Timeout' : e.message);
                document.getElementById('connection-status').innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span> Offline';
            } finally {
                clearTimeout(timeoutId);
                document.body.classList.remove('is-loading');
            }
        }

        function render() {
            const p = state.profile;
            const primary = themes[p.theme || 'blue'];
            document.documentElement.style.setProperty('--primary', primary);
            document.documentElement.classList.toggle('dark', p.darkMode);
            
            document.getElementById('user-display-name').innerText = state.user;
            document.getElementById('set-weight').value = p.weight;
            
            const fortBtn = document.getElementById('fortaleza-btn');
            fortBtn.querySelector('div').style.left = p.fortaleza ? '1.5rem' : '0.25rem';
            fortBtn.style.backgroundColor = p.fortaleza ? '#ea580c' : '';

            const darkBtn = document.getElementById('dark-btn-toggle');
            darkBtn.querySelector('div').style.left = p.darkMode ? '1.5rem' : '0.25rem';
            darkBtn.style.backgroundColor = p.darkMode ? primary : '';

            const today = new Date().toLocaleDateString('pt-BR');
            const meta = Math.round(p.weight * 35 * (p.fortaleza ? 1.2 : 1));
            const drank = state.water.filter(l => l.date === today).reduce((acc, l) => acc + l.amount, 0);
            
            document.getElementById('total-drank').innerText = drank;
            document.getElementById('meta-label').innerText = `Meta: ${meta}ml (Base: ${p.weight}kg + Clima)`;
            document.getElementById('progress-bar').style.width = Math.min((drank / meta) * 100, 100) + "%";

            document.getElementById('stat-liters').innerText = (state.water.reduce((a,b) => a + b.amount, 0) / 1000).toFixed(1) + "L";
            document.getElementById('stat-tasks').innerText = state.tasks.filter(t => t.completed).length;

            const list = document.getElementById('tasks-list');
            list.innerHTML = state.tasks.map(t => `
                <div onclick="toggleTask('${t.id}', ${t.completed})" class="p-4 rounded-2xl border flex items-center gap-4 cursor-pointer transition-all active:scale-[0.98] ${t.completed ? 'bg-emerald-500/10 border-emerald-500/20 text-emerald-600' : 'bg-white dark:bg-slate-900 border-slate-100 dark:border-slate-800 shadow-sm'}">
                    <i data-lucide="${t.completed ? 'check-circle-2' : 'circle'}" class="w-4.5 h-4.5"></i>
                    <span class="text-xs font-bold ${t.completed ? 'line-through opacity-40' : 'dark:text-slate-200'}">${t.name}</span>
                </div>
            `).join('');

            lucide.createIcons();
        }

        function renderThemeBtns() {
            const container = document.getElementById('theme-colors');
            if(!container) return;
            container.innerHTML = Object.keys(themes).map(name => `
                <button onclick="updateProfile('theme', '${name}')" class="w-10 h-10 rounded-2xl transition-all ${state.profile.theme === name ? 'ring-4 ring-offset-4 ring-blue-500/40 dark:ring-white/40 scale-110 shadow-lg' : 'opacity-40 hover:opacity-100'}" style="background-color: ${themes[name]}"></button>
            `).join('');
        }

        async function addWater(amount) {
            const data = { date: new Date().toLocaleDateString('pt-BR'), timestamp: Date.now(), amount };
            state.water.push(data);
            saveLocal();
            render();
            api('addWater', data);
        }

        async function toggleTask(id, current) {
            state.tasks = state.tasks.map(t => t.id === id ? {...t, completed: !current} : t);
            saveLocal();
            render();
            api('toggleTask', { id, completed: !current });
        }

        async function updateProfile(key, val) {
            state.profile[key] = isNaN(val) ? val : parseInt(val);
            saveLocal();
            render();
            api('saveProfile', state.profile);
        }

        function toggleDark() {
            state.profile.darkMode = !state.profile.darkMode;
            saveLocal();
            render();
            api('saveProfile', state.profile);
        }

        function toggleFortaleza() {
            state.profile.fortaleza = !state.profile.fortaleza;
            saveLocal();
            render();
            api('saveProfile', state.profile);
        }

        function setView(v) {
            state.view = v;
            document.querySelectorAll('.view-section').forEach(s => s.id === `view-${v}` ? s.classList.remove('hidden') : s.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(b => {
                const active = b.getAttribute('data-nav') === v;
                b.classList.toggle('theme-text', active);
                b.classList.toggle('bg-slate-100', active && window.innerWidth >= 768);
                b.classList.toggle('dark:bg-slate-800', active && window.innerWidth >= 768);
            });
            render();
        }

        function toggleSidebar() {
            state.sidebar = !state.sidebar;
            const sb = document.getElementById('sidebar');
            sb.style.width = state.sidebar ? '70px' : '224px';
            document.querySelectorAll('.sidebar-label').forEach(el => el.style.display = state.sidebar ? 'none' : 'block');
            document.getElementById('sidebar-icon').setAttribute('data-lucide', state.sidebar ? 'chevron-right' : 'chevron-left');
            lucide.createIcons();
        }

        function resetApp() {
            localStorage.clear();
            location.reload();
        }

        window.onload = () => {
            render();
            renderThemeBtns();
            api('getData'); // Tenta atualizar em background
        };
    </script>
</body>
</html>
